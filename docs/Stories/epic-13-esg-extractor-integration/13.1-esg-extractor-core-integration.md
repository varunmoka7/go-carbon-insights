# Story 13.1: ESG Extractor Core Integration

**Epic:** 13 - ESG Extractor Integration  
**Story Points:** 13  
**Priority:** High  
**Status:** üîÑ **REVIEW - REQUIRES REWORK**  
**Estimated Duration:** 2-3 weeks (Original) + 2-3 weeks (Rework)  
**Assignee:** TBD  
**Sprint:** TBD  
**QA Review:** Completed - January 8, 2025  

---

## 1. User Story

**As a** platform architect  
**I want to** integrate the Gemini API-powered ESG extractor into the GoCarbonTracker codebase  
**So that** the platform can process sustainability reports using AI-powered extraction with secure, scalable, and accurate data processing capabilities.

### Business Value
- **Strategic Impact**: Transform GoCarbonTracker from static data platform to intelligent ESG processing hub
- **User Experience**: Enable seamless AI-powered sustainability report processing
- **Competitive Advantage**: First-to-market with Gemini 2.5-flash powered ESG extraction
- **Revenue Potential**: Foundation for premium extraction services and enhanced Private ViewMode features

---

## QA Results

**QA Agent:** Quinn (Senior Developer & QA Architect)  
**Review Date:** January 8, 2025  
**Implementation Status:** 25% Complete - Requires Rework

### Executive Summary
The implementation shows a solid foundation for ESG extraction integration but has several critical gaps that prevent it from meeting the story's acceptance criteria. While the basic architecture is sound, key security, functionality, and testing requirements are not fully implemented.

**Final Verdict:** **Requires Rework** - The implementation needs significant improvements before it can be considered production-ready.

### File-by-File Review Results

#### 1. **vite.config.ts** - ‚úÖ **Approved with Suggestions**
- **Strengths:** Correctly implements proxy configuration for secure API routing
- **Issues:** Missing environment variable validation, no error handling for proxy failures
- **Recommendations:** Add environment validation and proxy error handling

#### 2. **src/types/esg-extraction.ts** - ‚ùå **Requires Rework**
- **Critical Issues:** Uses `any` types extensively, missing comprehensive type definitions
- **Required Fixes:** Replace all `any` types with proper interfaces, add validation types

#### 3. **src/types/gemini-api.ts** - ‚ùå **Requires Rework**
- **Critical Issues:** Placeholder implementation with minimal type definitions
- **Required Fixes:** Complete Gemini API request/response structures, integrate with ESG types

#### 4. **src/services/geminiAPI.ts** - ‚ùå **Requires Rework**
- **Critical Issues:** Missing rate limiting, retry logic, timeout handling
- **Required Fixes:** Implement rate limiting (60 requests/minute), exponential backoff, 30s timeout

#### 5. **src/components/ESGExtractor/ESGExtractorMain.tsx** - ‚ùå **Requires Rework**
- **Critical Issues:** Placeholder implementation with no actual functionality
- **Required Fixes:** Implement file upload interface, progress tracking, results display

#### 6. **src/hooks/useESGExtraction.ts** - ‚ùå **Requires Rework**
- **Critical Issues:** Missing proper state management, file processing logic
- **Required Fixes:** Complete extraction lifecycle management, add cancellation/retry

#### 7. **src/__tests__/services/geminiAPI.test.ts** - ‚ùå **Requires Rework**
- **Critical Issues:** Only 2 basic test cases, below 90% coverage requirement
- **Required Fixes:** Add comprehensive error scenario testing, rate limiting tests

### Critical Issues Summary

#### **Security Concerns**
1. **API Key Exposure Risk**: While proxy is configured, no validation of environment variables
2. **Missing Input Validation**: No sanitization of file content or API requests
3. **Incomplete Error Handling**: Sensitive information could leak in error messages

#### **Functionality Gaps**
1. **Missing Core Features**: File upload, progress tracking, results display not implemented
2. **Incomplete Type System**: Extensive use of `any` types violates TypeScript best practices
3. **No Rate Limiting**: Critical requirement from AC 2.1 not implemented
4. **Missing Retry Logic**: No exponential backoff for failed requests

#### **Testing Deficiencies**
1. **Insufficient Coverage**: Below 90% requirement with only 2 basic test cases
2. **Missing Edge Cases**: No testing for rate limits, timeouts, or error scenarios
3. **No Integration Tests**: Missing tests for component interactions

### Rework Priority Checklist

#### **Phase 1: Security & Infrastructure (Priority: Critical)**
- [ ] Implement environment variable validation in `vite.config.ts`
- [ ] Add comprehensive input validation and sanitization
- [ ] Implement proper error handling without sensitive data exposure
- [ ] Add request timeout handling (30 seconds max)

#### **Phase 2: Core Functionality (Priority: High)**
- [ ] Complete TypeScript type definitions (remove all `any` types)
- [ ] Implement rate limiting (60 requests/minute)
- [ ] Add retry logic with exponential backoff
- [ ] Implement file upload interface component
- [ ] Add progress tracking and results display components

#### **Phase 3: Service Layer (Priority: High)**
- [ ] Complete `GeminiAPIService` class implementation
- [ ] Add request queuing for concurrent processing
- [ ] Implement cost tracking and usage monitoring
- [ ] Add comprehensive error categorization

#### **Phase 4: Testing (Priority: Medium)**
- [ ] Achieve 90%+ unit test coverage
- [ ] Add comprehensive error scenario testing
- [ ] Implement integration tests for component interactions
- [ ] Add performance testing for concurrent processing

#### **Phase 5: Integration & Polish (Priority: Medium)**
- [ ] Integrate with existing ViewMode system
- [ ] Add accessibility features (WCAG 2.1 AA compliance)
- [ ] Implement mobile-responsive design
- [ ] Add comprehensive error recovery mechanisms

### Final Recommendation
**Story Status:** **Remains in Review**

The implementation provides a basic foundation but requires significant rework to meet the acceptance criteria. The current state is approximately 25% complete according to the story requirements.

**Key Recommendations:**
1. **Immediate Focus**: Security and core functionality implementation
2. **Testing Priority**: Achieve 90%+ coverage before proceeding
3. **Type Safety**: Eliminate all `any` types and implement comprehensive interfaces
4. **Performance**: Implement rate limiting and request queuing
5. **User Experience**: Complete the UI components for file upload and results display

---

## 2. Acceptance Criteria

### üîÑ **AC 2.1: Gemini API Integration with Secure Key Management** - **PARTIALLY COMPLETE**
**Given** the GoCarbonTracker platform needs AI-powered ESG extraction  
**When** I integrate the Gemini API service  
**Then** I must implement:
- ‚úÖ Secure API key management with environment variable configuration (Basic proxy setup complete)
- ‚ùå Request authentication with proper headers and payload structure (Not implemented)
- ‚ùå Rate limiting implementation (60 requests/minute for Gemini 2.5-flash) (Not implemented)
- ‚ùå Retry logic with exponential backoff for failed requests (Not implemented)
- ‚ùå Request/response logging for debugging and monitoring (Not implemented)
- ‚ùå Cost tracking and usage monitoring (Not implemented)

**Technical Requirements:**
- ‚ùå Use `@google/generative-ai` SDK v0.15.0+ (Not implemented)
- üîÑ Environment variable: `VITE_GEMINI_API_KEY` (Proxy configured, validation missing)
- ‚ùå Implement request queuing for concurrent processing (Not implemented)
- ‚ùå Add request timeout handling (30 seconds max) (Not implemented)

**QA Notes:** Basic proxy configuration is in place, but critical security and performance features are missing.

### ‚ùå **AC 2.2: TypeScript Interfaces for All ESG Extraction Data Types** - **REQUIRES COMPLETE OVERHAUL**
**Given** that the platform processes various ESG data formats  
**When** I define the type system for ESG extraction  
**Then** I must create comprehensive interfaces for:
- ‚ùå Extraction request/response structures (Placeholder with `any` types)
- ‚ùå Multi-format file processing (PDF, TXT, CSV, MD) (Not implemented)
- ‚ùå Industry-specific extractor configurations (Not implemented)
- ‚ùå Emissions data with Scope 1, 2, 3 breakdowns (Using `any` types)
- ‚ùå Target and policy extraction structures (Using `any` types)
- ‚ùå Benchmarking and comparison data types (Using `any` types)
- ‚ùå Error handling and validation types (Not implemented)

**Technical Requirements:**
- ‚ùå Full TypeScript coverage with strict mode compliance (Extensive `any` usage)
- ‚ùå JSON schema validation for API payloads (Not implemented)
- ‚ùå Type guards for runtime validation (Not implemented)
- ‚ùå Integration with existing `Company` and `EmissionsData` types (Not implemented)
- ‚ùå Backwards compatibility with existing ESG data structures (Not implemented)

**QA Notes:** Current implementation uses extensive `any` types, violating TypeScript best practices. Complete type system overhaul required.

### ‚ùå **AC 2.3: React Component Architecture for Extraction Workflow** - **PLACEHOLDER IMPLEMENTATION**
**Given** users need an intuitive interface for ESG extraction  
**When** I design the component architecture  
**Then** I must implement:
- üîÑ Modular component structure following existing patterns (Basic structure exists)
- ‚ùå Drag-and-drop file upload interface (Not implemented)
- ‚ùå Real-time progress tracking with visual indicators (Not implemented)
- ‚ùå Interactive results display with filtering and sorting (Not implemented)
- ‚ùå Industry extractor selection interface (Not implemented)
- ‚ùå Error handling with user-friendly messaging (Not implemented)
- ‚ùå Mobile-responsive design patterns (Not implemented)

**Technical Requirements:**
- üîÑ Follow existing component patterns in `/src/components/` (Basic structure follows patterns)
- üîÑ Use existing UI library components (shadcn/ui) (Basic card structure used)
- ‚ùå Implement proper accessibility (WCAG 2.1 AA compliance) (Not implemented)
- ‚ùå State management with React hooks following existing patterns (Placeholder implementation)
- ‚ùå Component testing with Jest and React Testing Library (Not implemented)

**QA Notes:** Only basic component structure exists with placeholder content. All core functionality is missing.

### ‚ùå **AC 2.4: Error Handling and API Rate Limiting Implementation** - **NOT IMPLEMENTED**
**Given** the Gemini API has usage limits and can fail  
**When** I implement error handling and rate limiting  
**Then** I must ensure:
- ‚ùå Graceful degradation for API failures (Basic error handling only)
- ‚ùå User-friendly error messages with recovery suggestions (Not implemented)
- ‚ùå Automatic retry mechanisms with intelligent backoff (Not implemented)
- ‚ùå Rate limiting compliance with Gemini API quotas (Not implemented)
- ‚ùå Circuit breaker pattern for service resilience (Not implemented)
- ‚ùå Comprehensive error logging and monitoring (Not implemented)

**Technical Requirements:**
- ‚ùå Implement exponential backoff with jitter (Not implemented)
- ‚ùå Rate limiting: 60 requests/minute, 1000 requests/day (Not implemented)
- ‚ùå Error categorization: network, API, validation, processing (Not implemented)
- ‚ùå User notification system for extraction failures (Not implemented)
- ‚ùå Fallback mechanisms for service outages (Not implemented)

**QA Notes:** Only basic error handling exists. Critical rate limiting and retry logic are completely missing.

### ‚ùå **AC 2.5: Unit Test Coverage for Core Extraction Functionality** - **BELOW REQUIREMENT**
**Given** the extraction system is mission-critical  
**When** I implement testing for core functionality  
**Then** I must achieve:
- ‚ùå 90%+ unit test coverage for extraction logic (Only 2 basic test cases)
- ‚ùå Integration tests for Gemini API interactions (Not implemented)
- üîÑ Mock implementations for external API calls (Basic fetch mocking)
- ‚ùå End-to-end testing for extraction workflows (Not implemented)
- ‚ùå Performance testing for concurrent processing (Not implemented)
- ‚ùå Error scenario testing with comprehensive edge cases (Not implemented)

**Technical Requirements:**
- üîÑ Jest + React Testing Library for component testing (Basic setup exists)
- ‚ùå MSW (Mock Service Worker) for API mocking (Not implemented)
- ‚ùå Performance testing with Lighthouse and custom metrics (Not implemented)
- ‚ùå Automated testing in CI/CD pipeline (Not implemented)
- ‚ùå Test data fixtures for various document types (Not implemented)

**QA Notes:** Only 2 basic test cases exist, well below the 90% coverage requirement. Comprehensive testing framework needed.

### ‚úÖ **AC 2.6: Integration with Existing Vite Build System** - **COMPLETE WITH SUGGESTIONS**
**Given** the platform uses Vite for build and development  
**When** I integrate new extraction functionality  
**Then** I must ensure:
- ‚úÖ Seamless integration with existing Vite configuration (Complete)
- üîÑ Proper environment variable handling for API keys (Proxy configured, validation missing)
- ‚ùå Optimized bundle splitting for extraction components (Not implemented)
- ‚úÖ Development server proxy configuration for API calls (Complete)
- ‚ùå Production build optimization with code splitting (Not implemented)
- ‚úÖ Hot module replacement (HMR) support for development (Inherited from existing config)

**Technical Requirements:**
- ‚úÖ Update `vite.config.ts` with extraction service proxies (Complete)
- ‚ùå Environment variable validation at build time (Not implemented)
- ‚ùå Lazy loading for extraction components (Not implemented)
- ‚ùå Bundle size optimization (<500KB for extraction modules) (Not implemented)
- ‚úÖ TypeScript path mapping for extraction modules (Inherited from existing config)

**QA Notes:** Basic proxy configuration is complete and functional. Missing environment validation and optimization features.

### ‚ùå **AC 2.7: Performance Optimization for Client-Side Processing** - **NOT IMPLEMENTED**
**Given** ESG extraction can be resource-intensive  
**When** I optimize for client-side performance  
**Then** I must implement:
- ‚ùå Efficient file processing with streaming for large documents (Not implemented)
- ‚ùå Memory management for PDF parsing operations (Not implemented)
- ‚ùå Progressive data loading for large extraction results (Not implemented)
- ‚ùå Caching strategies for frequently accessed data (Not implemented)
- ‚ùå Lazy loading for non-critical extraction components (Not implemented)
- ‚ùå Performance monitoring and metrics collection (Not implemented)

**Technical Requirements:**
- ‚ùå File processing: <100MB memory footprint (Not implemented)
- ‚ùå PDF parsing with `pdf.js` in web worker (Not implemented)
- ‚ùå Virtual scrolling for large result sets (Not implemented)
- ‚ùå LocalStorage caching for extraction preferences (Not implemented)
- ‚ùå Performance monitoring with Web Vitals (Not implemented)
- ‚ùå Target: <2 second initial load time (Not measured)

**QA Notes:** No performance optimization features implemented. Core functionality must be completed first.

---

## 3. Technical Implementation Plan

### 3.1 **Core Architecture Components**

#### **3.1.1 Type System Foundation**
```typescript
// /src/types/esg-extraction.ts
export interface ESGExtractionRequest {
  fileId: string;
  fileName: string;
  fileType: 'pdf' | 'txt' | 'csv' | 'md';
  fileSize: number;
  organizationId: string;
  extractorType: ExtractorType;
  processingOptions: ExtractionOptions;
  uploadedAt: string;
}

export interface ESGExtractionResult {
  extractionId: string;
  request: ESGExtractionRequest;
  status: ExtractionStatus;
  progress: ExtractionProgress;
  startedAt: string;
  completedAt?: string;
  extractedData: ExtractedESGData;
  validationResults: ValidationResult[];
  confidenceScores: ConfidenceScoring;
  errors: ExtractionError[];
}

export interface ExtractedESGData {
  companyInfo: ExtractedCompanyInfo;
  emissions: ExtractedEmissions;
  targets: ExtractedTarget[];
  policies: ExtractedPolicy[];
  financialMetrics: ExtractedFinancialData;
  operationalMetrics: ExtractedOperationalData;
  metadata: ExtractionMetadata;
}

export type ExtractorType = 
  | 'standard' 
  | 'banking' 
  | 'apparel' 
  | 'waste_management' 
  | 'carbon_levers';

export type ExtractionStatus = 
  | 'pending' 
  | 'processing' 
  | 'validating' 
  | 'completed' 
  | 'failed' 
  | 'cancelled';
```

#### **3.1.2 Gemini API Service Integration**
```typescript
// /src/services/geminiAPI.ts
export class GeminiAPIService {
  private apiKey: string;
  private baseURL: string;
  private rateLimiter: RateLimiter;
  private retryConfig: RetryConfiguration;

  async extractESGData(
    fileContent: string,
    extractorType: ExtractorType,
    options: ExtractionOptions
  ): Promise<ESGExtractionResult> {
    // Implementation with rate limiting, retries, error handling
  }

  async validateExtraction(
    extractedData: ExtractedESGData
  ): Promise<ValidationResult[]> {
    // Self-correction validation implementation
  }

  private buildPrompt(
    content: string, 
    extractorType: ExtractorType
  ): string {
    // Industry-specific prompt engineering
  }
}
```

#### **3.1.3 Core Extraction Hook**
```typescript
// /src/hooks/useESGExtraction.ts
export interface UseESGExtractionReturn {
  extractESGData: (file: File, options: ExtractionOptions) => Promise<void>;
  extractionState: ExtractionState;
  currentExtraction: ESGExtractionResult | null;
  extractionHistory: ESGExtractionResult[];
  cancelExtraction: () => void;
  retryExtraction: (extractionId: string) => Promise<void>;
  isLoading: boolean;
  error: string | null;
}

export const useESGExtraction = (): UseESGExtractionReturn => {
  // Implementation with state management, file processing, API calls
};
```

### 3.2 **Component Architecture**

#### **3.2.1 Main Extraction Interface**
```typescript
// /src/components/ESGExtractor/ESGExtractorMain.tsx
export interface ESGExtractorMainProps {
  organizationId: string;
  viewMode: ViewMode;
  onExtractionComplete?: (result: ESGExtractionResult) => void;
  onError?: (error: ExtractionError) => void;
}

export const ESGExtractorMain: React.FC<ESGExtractorMainProps> = ({
  organizationId,
  viewMode,
  onExtractionComplete,
  onError
}) => {
  // Main extraction workflow orchestration
};
```

#### **3.2.2 File Upload Interface**
```typescript
// /src/components/ESGExtractor/FileUploadInterface.tsx
export interface FileUploadInterfaceProps {
  onFileSelect: (files: File[]) => void;
  acceptedFormats: string[];
  maxFileSize: number;
  maxFiles: number;
  disabled?: boolean;
}

export const FileUploadInterface: React.FC<FileUploadInterfaceProps> = ({
  onFileSelect,
  acceptedFormats,
  maxFileSize,
  maxFiles,
  disabled
}) => {
  // Drag-and-drop file upload with validation
};
```

#### **3.2.3 Real-time Progress Component**
```typescript
// /src/components/ESGExtractor/ExtractionProgress.tsx
export interface ExtractionProgressProps {
  extraction: ESGExtractionResult;
  onCancel?: () => void;
  detailed?: boolean;
}

export const ExtractionProgress: React.FC<ExtractionProgressProps> = ({
  extraction,
  onCancel,
  detailed
}) => {
  // Real-time progress visualization with cancellation
};
```

### 3.3 **Database Schema Extensions**

#### **3.3.1 Core Extraction Tables**
```sql
-- /migrations/20260101_epic13_esg_extraction_schema.sql

-- ESG Extractions tracking table
CREATE TABLE esg_extractions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  file_name TEXT NOT NULL,
  file_type TEXT NOT NULL CHECK (file_type IN ('pdf', 'txt', 'csv', 'md')),
  file_size BIGINT NOT NULL,
  extractor_type TEXT NOT NULL CHECK (extractor_type IN 
    ('standard', 'banking', 'apparel', 'waste_management', 'carbon_levers')),
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN 
    ('pending', 'processing', 'validating', 'completed', 'failed', 'cancelled')),
  progress_percentage INTEGER DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
  confidence_score DECIMAL(3,2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
  processing_options JSONB DEFAULT '{}',
  error_details JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  started_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Extracted ESG metrics storage
CREATE TABLE extracted_esg_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  extraction_id UUID REFERENCES esg_extractions(id) ON DELETE CASCADE,
  metric_category TEXT NOT NULL, -- 'emissions', 'targets', 'policies', 'financial', 'operational'
  metric_type TEXT NOT NULL,
  metric_value JSONB NOT NULL,
  confidence_score DECIMAL(3,2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
  source_section TEXT,
  source_page INTEGER,
  validation_status TEXT DEFAULT 'pending' CHECK (validation_status IN 
    ('pending', 'validated', 'flagged', 'rejected')),
  validation_notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- File storage references for uploaded documents
CREATE TABLE extraction_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  extraction_id UUID REFERENCES esg_extractions(id) ON DELETE CASCADE,
  file_path TEXT NOT NULL, -- Supabase Storage path
  file_hash TEXT NOT NULL, -- SHA-256 hash for deduplication
  mime_type TEXT NOT NULL,
  processed_content_path TEXT, -- Path to processed/parsed content
  virus_scan_status TEXT DEFAULT 'pending' CHECK (virus_scan_status IN 
    ('pending', 'clean', 'infected', 'failed')),
  virus_scan_result JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **3.3.2 Performance Indexes**
```sql
-- /migrations/20260102_epic13_extraction_indexes.sql

-- Performance indexes for extraction queries
CREATE INDEX idx_esg_extractions_org_status ON esg_extractions(organization_id, status);
CREATE INDEX idx_esg_extractions_user_created ON esg_extractions(user_id, created_at DESC);
CREATE INDEX idx_esg_extractions_status_updated ON esg_extractions(status, updated_at DESC);

-- Indexes for metrics queries
CREATE INDEX idx_extracted_metrics_extraction ON extracted_esg_metrics(extraction_id);
CREATE INDEX idx_extracted_metrics_category ON extracted_esg_metrics(metric_category, metric_type);
CREATE INDEX idx_extracted_metrics_confidence ON extracted_esg_metrics(confidence_score DESC);

-- File processing indexes
CREATE INDEX idx_extraction_files_hash ON extraction_files(file_hash);
CREATE INDEX idx_extraction_files_scan_status ON extraction_files(virus_scan_status);
```

#### **3.3.3 Row Level Security (RLS) Policies**
```sql
-- /migrations/20260103_epic13_rls_policies.sql

-- Enable RLS on extraction tables
ALTER TABLE esg_extractions ENABLE ROW LEVEL SECURITY;
ALTER TABLE extracted_esg_metrics ENABLE ROW LEVEL SECURITY;
ALTER TABLE extraction_files ENABLE ROW LEVEL SECURITY;

-- Extraction access policies
CREATE POLICY "extraction_org_access" ON esg_extractions
  FOR ALL USING (
    organization_id IN (
      SELECT organization_id 
      FROM organization_members 
      WHERE user_id = auth.uid()
    )
  );

-- Metrics access policies
CREATE POLICY "metrics_extraction_access" ON extracted_esg_metrics
  FOR ALL USING (
    extraction_id IN (
      SELECT id 
      FROM esg_extractions 
      WHERE organization_id IN (
        SELECT organization_id 
        FROM organization_members 
        WHERE user_id = auth.uid()
      )
    )
  );

-- File access policies
CREATE POLICY "files_extraction_access" ON extraction_files
  FOR ALL USING (
    extraction_id IN (
      SELECT id 
      FROM esg_extractions 
      WHERE organization_id IN (
        SELECT organization_id 
        FROM organization_members 
        WHERE user_id = auth.uid()
      )
    )
  );
```

### 3.4 **Integration Specifications**

#### **3.4.1 ViewMode System Integration**
- **Private Mode**: ESG extraction only available in Private ViewMode for authenticated users with organization access
- **Organization Isolation**: All extracted data scoped to user's organization
- **Permission Levels**: Role-based access (owner/admin can extract, members can view, viewers read-only)
- **Data Privacy**: Extraction respects organization privacy settings

#### **3.4.2 Existing Component Integration Points**
```typescript
// /src/components/Layout.tsx - Add ESG Extractor navigation
const navigationItems = [
  // ... existing items
  {
    path: '/private/esg-extractor',
    label: 'ESG Extractor',
    icon: 'FileText',
    requiresAuth: true,
    viewModes: ['private', 'combined']
  }
];

// /src/components/ViewModeToggle.tsx - Show extraction capabilities
const modeCapabilities = {
  private: [
    'Organization data',
    'ESG Report Extraction', // NEW
    'Team collaboration'
  ]
};
```

#### **3.4.3 Company Data Type Extensions**
```typescript
// /src/types/company.ts - Extend with extraction data
export interface Company {
  // ... existing properties
  
  // Epic 13: ESG Extraction Integration
  extractedESGData?: {
    extractionId: string;
    extractedAt: string;
    extractorType: ExtractorType;
    confidenceScore: number;
    sourceDocument: string;
    validationStatus: 'validated' | 'pending' | 'flagged';
  };
  
  hasExtractedData?: boolean;
  lastExtractionDate?: string;
  extractionCount?: number;
}
```

---

## 4. Testing Strategy and Validation Approach

### 4.1 **Unit Testing Requirements**

#### **4.1.1 Service Layer Testing**
```typescript
// /src/__tests__/services/geminiAPI.test.ts
describe('GeminiAPIService', () => {
  test('should extract ESG data from PDF content', async () => {
    // Test Gemini API integration with mocked responses
  });

  test('should handle rate limiting gracefully', async () => {
    // Test rate limiting and retry logic
  });

  test('should validate extracted data correctly', async () => {
    // Test validation and self-correction features
  });
});
```

#### **4.1.2 Hook Testing**
```typescript
// /src/__tests__/hooks/useESGExtraction.test.ts
describe('useESGExtraction', () => {
  test('should manage extraction state correctly', async () => {
    // Test state management and lifecycle
  });

  test('should handle file processing errors', async () => {
    // Test error handling scenarios
  });
});
```

#### **4.1.3 Component Testing**
```typescript
// /src/__tests__/components/ESGExtractor/ESGExtractorMain.test.tsx
describe('ESGExtractorMain', () => {
  test('should render file upload interface', () => {
    // Test component rendering and interactions
  });

  test('should display extraction progress', async () => {
    // Test progress visualization
  });
});
```

### 4.2 **Integration Testing**

#### **4.2.1 API Integration Tests**
- Mock Gemini API responses for various scenarios
- Test authentication and authorization flows
- Validate data persistence in Supabase
- Test file upload and storage integration

#### **4.2.2 Database Integration Tests**
- Test RLS policies with different user roles
- Validate data integrity and constraints
- Test migration scripts and rollback procedures
- Performance testing for large extraction datasets

### 4.3 **End-to-End Testing**

#### **4.3.1 User Workflow Testing**
- Complete extraction workflow from file upload to results display
- Multi-format file processing validation
- Error handling and recovery scenarios
- Mobile responsiveness testing

#### **4.3.2 Performance Testing**
- Concurrent user extraction processing
- Large file handling (up to 10MB PDFs)
- Memory usage optimization validation
- API response time compliance

---

## 5. Error Handling and Validation Patterns

### 5.1 **Error Classification System**

```typescript
export enum ExtractionErrorType {
  // File Processing Errors
  FILE_TOO_LARGE = 'FILE_TOO_LARGE',
  UNSUPPORTED_FORMAT = 'UNSUPPORTED_FORMAT',
  CORRUPTED_FILE = 'CORRUPTED_FILE',
  VIRUS_DETECTED = 'VIRUS_DETECTED',
  
  // API Errors
  API_RATE_LIMIT = 'API_RATE_LIMIT',
  API_QUOTA_EXCEEDED = 'API_QUOTA_EXCEEDED',
  API_AUTHENTICATION = 'API_AUTHENTICATION',
  API_TIMEOUT = 'API_TIMEOUT',
  
  // Processing Errors
  CONTENT_EXTRACTION_FAILED = 'CONTENT_EXTRACTION_FAILED',
  INSUFFICIENT_DATA = 'INSUFFICIENT_DATA',
  VALIDATION_FAILED = 'VALIDATION_FAILED',
  
  // System Errors
  DATABASE_ERROR = 'DATABASE_ERROR',
  STORAGE_ERROR = 'STORAGE_ERROR',
  PERMISSION_DENIED = 'PERMISSION_DENIED'
}

export interface ExtractionError {
  type: ExtractionErrorType;
  message: string;
  details?: Record<string, any>;
  timestamp: string;
  recoverable: boolean;
  suggestedAction?: string;
}
```

### 5.2 **Validation Framework**

```typescript
export interface ValidationRule {
  name: string;
  description: string;
  validate: (data: any) => ValidationResult;
  severity: 'error' | 'warning' | 'info';
}

export const validationRules: ValidationRule[] = [
  {
    name: 'emissions_data_completeness',
    description: 'Validate presence of required emissions data',
    validate: (data: ExtractedEmissions) => {
      // Validation logic
    },
    severity: 'error'
  },
  // ... additional validation rules
];
```

### 5.3 **User-Friendly Error Messages**

```typescript
export const errorMessages: Record<ExtractionErrorType, string> = {
  [ExtractionErrorType.FILE_TOO_LARGE]: 
    'File size exceeds 10MB limit. Please compress your document or split into smaller files.',
  [ExtractionErrorType.API_RATE_LIMIT]: 
    'Processing limit reached. Please wait a moment before uploading another file.',
  [ExtractionErrorType.INSUFFICIENT_DATA]: 
    'Unable to extract sufficient ESG data from this document. Please ensure it contains sustainability metrics.',
  // ... additional user-friendly messages
};
```

---

## 6. Performance Requirements and Optimization Strategy

### 6.1 **Performance Targets**

| Metric | Target | Measurement Method |
|--------|--------|-------------------|
| Extraction Processing Time | <2 minutes for 20-50 page reports | Server-side timing |
| API Response Time | <5 seconds for extraction initiation | Client-side measurement |
| File Upload Speed | <30 seconds for 10MB files | Network timing |
| UI Responsiveness | <100ms for user interactions | Web Vitals |
| Memory Usage | <100MB per extraction | Browser DevTools |
| Concurrent Users | 50+ simultaneous extractions | Load testing |

### 6.2 **Optimization Strategies**

#### **6.2.1 Client-Side Optimizations**
- **Lazy Loading**: Load extraction components only when needed
- **Code Splitting**: Separate extraction modules from main bundle
- **Web Workers**: PDF parsing in background threads
- **Virtual Scrolling**: Efficient rendering of large result sets
- **Caching**: LocalStorage for user preferences and recent extractions

#### **6.2.2 Server-Side Optimizations**
- **Request Queuing**: Intelligent batching for Gemini API calls
- **Connection Pooling**: Efficient database connection management
- **Caching Layer**: Redis for frequently accessed data
- **File Streaming**: Progressive file processing for large documents
- **CDN Integration**: Fast file delivery and static asset caching

#### **6.2.3 Database Optimizations**
- **Indexing Strategy**: Optimized indexes for common query patterns
- **Partitioning**: Time-based partitioning for extraction history
- **Materialized Views**: Pre-computed aggregations for analytics
- **Query Optimization**: Efficient RLS policy implementation

### 6.3 **Monitoring and Alerting**

```typescript
// Performance monitoring integration
export interface PerformanceMetrics {
  extractionStartTime: number;
  fileProcessingTime: number;
  apiCallDuration: number;
  validationTime: number;
  totalProcessingTime: number;
  memoryUsage: number;
  errorCount: number;
}

export const trackExtractionPerformance = (
  extractionId: string,
  metrics: PerformanceMetrics
) => {
  // Send metrics to monitoring service
  // Set up alerts for performance degradation
};
```

---

## 7. Security Considerations

### 7.1 **Data Security Measures**

#### **7.1.1 File Upload Security**
- **Virus Scanning**: Automated scanning for all uploaded files
- **File Type Validation**: Strict MIME type checking
- **Size Limits**: 10MB maximum file size enforcement
- **Content Sanitization**: Strip potentially malicious content
- **Secure Storage**: Encrypted storage in Supabase with access controls

#### **7.1.2 API Security**
- **API Key Protection**: Secure environment variable management
- **Request Signing**: Authentication for Gemini API calls
- **Rate Limiting**: Protection against abuse and cost overruns
- **Request Validation**: Input sanitization and validation
- **Audit Logging**: Comprehensive request/response logging

#### **7.1.3 Data Privacy**
- **Organization Isolation**: Strict data scoping to user's organization
- **RLS Enforcement**: Database-level access controls
- **Data Encryption**: Encryption at rest and in transit
- **Retention Policies**: Configurable data retention periods
- **GDPR Compliance**: Right to deletion and data portability

### 7.2 **Access Control Integration**

```typescript
export interface ExtractionPermissions {
  canInitiateExtraction: boolean;
  canViewExtractions: boolean;
  canDeleteExtractions: boolean;
  canExportData: boolean;
  canManageSettings: boolean;
}

export const getExtractionPermissions = (
  userRole: OrganizationRole,
  privacySettings: OrganizationPrivacySettings
): ExtractionPermissions => {
  // Role-based permission calculation
};
```

---

## 8. Definition of Done

### 8.1 **Development Completion Criteria**

- [ ] **Code Implementation**: All components, hooks, and services implemented according to specifications
- [ ] **Type Safety**: 100% TypeScript coverage with strict mode compliance
- [ ] **Testing**: 90%+ unit test coverage, integration tests passing
- [ ] **Performance**: All performance targets met in testing environment
- [ ] **Security**: Security review completed, vulnerabilities addressed
- [ ] **Documentation**: Technical documentation and API docs updated

### 8.2 **Quality Assurance Criteria**

- [ ] **Functional Testing**: All acceptance criteria validated
- [ ] **Cross-Browser Testing**: Chrome, Firefox, Safari compatibility
- [ ] **Mobile Testing**: Responsive design on iOS and Android
- [ ] **Accessibility**: WCAG 2.1 AA compliance verified
- [ ] **Load Testing**: Performance under expected user load
- [ ] **Error Handling**: All error scenarios tested and handled gracefully

### 8.3 **Deployment Readiness**

- [ ] **Environment Configuration**: All environment variables configured
- [ ] **Database Migrations**: Migration scripts tested and deployed
- [ ] **API Keys**: Gemini API access configured and tested
- [ ] **Monitoring**: Performance monitoring and alerting configured
- [ ] **Rollback Plan**: Rollback procedures documented and tested
- [ ] **User Training**: Documentation for end users prepared

---

## 9. Dependencies and Risks

### 9.1 **Internal Dependencies**

| Dependency | Status | Risk Level | Mitigation Strategy |
|------------|--------|------------|-------------------|
| **Epic 1 (Authentication)** | ‚úÖ Complete | Low | Authentication system operational |
| **Epic 2 (Public Platform)** | ‚úÖ Complete | Low | Database schema and API available |
| **Epic 3 (ViewMode System)** | ‚úÖ Complete | Low | Private ViewMode infrastructure ready |
| **Epic 5 (Trancenable Data)** | ‚úÖ Complete | Low | Benchmarking data available |

### 9.2 **External Dependencies**

| Dependency | Risk Level | Mitigation Strategy |
|------------|------------|-------------------|
| **Gemini API Availability** | Medium | Implement fallback processing, API health monitoring |
| **Google AI SDK Updates** | Low | Pin SDK version, test updates in staging |
| **Supabase Storage Limits** | Low | Monitor usage, implement cleanup policies |
| **PDF.js Compatibility** | Low | Use stable version, test with various PDF formats |

### 9.3 **Risk Assessment**

#### **9.3.1 Technical Risks**

**üî¥ High Risk**: Gemini API Rate Limiting Impact
- **Impact**: Could limit concurrent user processing
- **Probability**: Medium
- **Mitigation**: Implement intelligent queuing, user communication, alternative processing options

**üü° Medium Risk**: Large File Processing Performance  
- **Impact**: User experience degradation for large documents
- **Probability**: Medium  
- **Mitigation**: Streaming processing, progress indicators, file size optimization guidance

**üü¢ Low Risk**: Browser Compatibility Issues
- **Impact**: Limited user access on older browsers
- **Probability**: Low
- **Mitigation**: Progressive enhancement, graceful degradation, browser support testing

#### **9.3.2 Business Risks**

**üü° Medium Risk**: User Adoption Rate
- **Impact**: Low utilization of extraction features
- **Probability**: Medium
- **Mitigation**: User onboarding, training materials, gradual feature introduction

**üü¢ Low Risk**: Cost Overruns from API Usage
- **Impact**: Higher than expected operational costs
- **Probability**: Low
- **Mitigation**: Usage monitoring, cost alerts, rate limiting

---

## 10. Success Metrics and Validation

### 10.1 **Technical Success Metrics**

| Metric | Target | Measurement Method | Success Criteria |
|--------|--------|-------------------|------------------|
| **API Response Time** | <5 seconds | Application Performance Monitoring | 95% of requests under target |
| **Extraction Accuracy** | >90% | Manual validation sample | Statistical significance |
| **System Uptime** | >99.5% | Infrastructure monitoring | Monthly uptime tracking |
| **Error Rate** | <2% | Application logging | Failed extractions percentage |
| **Test Coverage** | >90% | Code coverage tools | Automated CI/CD validation |

### 10.2 **User Experience Metrics**

| Metric | Target | Measurement Method | Success Criteria |
|--------|--------|-------------------|------------------|
| **Task Completion Rate** | >85% | User analytics | Successful extraction workflows |
| **Time to First Result** | <3 minutes | User session tracking | From upload to first preview |
| **User Satisfaction** | >4.0/5.0 | In-app feedback surveys | Monthly survey results |
| **Feature Adoption** | >40% | Feature usage analytics | Of Private ViewMode users |
| **Support Tickets** | <5% | Customer support metrics | Extraction-related issues |

### 10.3 **Business Impact Metrics**

| Metric | Target | Measurement Method | Success Criteria |
|--------|--------|-------------------|------------------|
| **User Retention** | +15% | Cohort analysis | Private ViewMode users |
| **Premium Conversions** | +20% | Subscription analytics | Extraction feature influence |
| **Processing Volume** | 500+ documents/month | Application metrics | Within first 3 months |
| **Cost Per Extraction** | <$2.00 | Financial analysis | Including API and infrastructure costs |

---

## 11. Files and Components to Create/Modify

### 11.1 **New Files to Create**

#### **11.1.1 Type Definitions**
```
/src/types/
‚îú‚îÄ‚îÄ esg-extraction.ts              # Core extraction type definitions
‚îú‚îÄ‚îÄ gemini-api.ts                  # Gemini API interfaces
‚îî‚îÄ‚îÄ extraction-validation.ts       # Validation and error types
```

#### **11.1.2 Services**
```
/src/services/
‚îú‚îÄ‚îÄ geminiAPI.ts                   # Gemini API integration service
‚îú‚îÄ‚îÄ esgExtraction.ts               # Core extraction orchestration
‚îú‚îÄ‚îÄ fileProcessing.ts              # Multi-format file processing
‚îî‚îÄ‚îÄ extractionValidation.ts        # Data validation service
```

#### **11.1.3 Hooks**
```
/src/hooks/
‚îú‚îÄ‚îÄ useESGExtraction.ts            # Main extraction logic hook
‚îú‚îÄ‚îÄ useFileUpload.ts               # File upload management
‚îú‚îÄ‚îÄ useExtractionProgress.ts       # Real-time progress tracking
‚îî‚îÄ‚îÄ useExtractionHistory.ts        # Historical data management
```

#### **11.1.4 Components**
```
/src/components/ESGExtractor/
‚îú‚îÄ‚îÄ ESGExtractorMain.tsx           # Main extraction interface
‚îú‚îÄ‚îÄ FileUploadInterface.tsx        # Drag-and-drop file upload
‚îú‚îÄ‚îÄ ExtractionProgress.tsx         # Real-time progress display
‚îú‚îÄ‚îÄ ResultsDisplay.tsx             # Comprehensive results interface
‚îú‚îÄ‚îÄ ExtractorSelector.tsx          # Industry extractor selection
‚îú‚îÄ‚îÄ ValidationResults.tsx          # Validation and confidence display
‚îî‚îÄ‚îÄ ExtractionHistory.tsx          # Historical extractions list
```

#### **11.1.5 Database Migrations**
```
/migrations/
‚îú‚îÄ‚îÄ 20260101_epic13_esg_extraction_schema.sql
‚îú‚îÄ‚îÄ 20260102_epic13_extraction_indexes.sql
‚îî‚îÄ‚îÄ 20260103_epic13_rls_policies.sql
```

#### **11.1.6 Testing Files**
```
/src/__tests__/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ geminiAPI.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ esgExtraction.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ fileProcessing.test.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useESGExtraction.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ useFileUpload.test.ts
‚îî‚îÄ‚îÄ components/ESGExtractor/
    ‚îú‚îÄ‚îÄ ESGExtractorMain.test.tsx
    ‚îú‚îÄ‚îÄ FileUploadInterface.test.tsx
    ‚îî‚îÄ‚îÄ ExtractionProgress.test.tsx
```

### 11.2 **Existing Files to Modify**

#### **11.2.1 Type Extensions**
```
/src/types/company.ts              # Add extraction data integration
/src/types/esg.ts                  # Extend with extraction types
```

#### **11.2.2 Navigation and Layout**
```
/src/components/Layout.tsx         # Add ESG Extractor navigation
/src/components/Sidebar.tsx        # Extraction menu items
/src/components/ViewModeToggle.tsx # Show extraction capabilities
```

#### **11.2.3 Configuration**
```
/vite.config.ts                    # Environment variables, proxies
/.env.example                      # Add Gemini API key template
/package.json                      # Add required dependencies
```

#### **11.2.4 Context Integration**
```
/src/contexts/ViewModeContext.tsx  # Extraction permissions
/src/hooks/useOrganizationContext.ts # Extraction settings
```

---

## 12. Change Log

| Date | Version | Description of Change | Author |
|:-----|:--------|:---------------------|:-------|
| 2025-08-01 | 1.0 | Initial story breakdown creation | Claude |
| 2025-08-01 | 1.1 | Added comprehensive technical specifications | Claude |
| 2025-08-01 | 1.2 | Enhanced testing strategy and validation approach | Claude |
| 2025-08-01 | 1.3 | **FINAL**: Complete implementation plan with acceptance criteria | Claude |
| 2025-01-08 | 1.4 | **QA REVIEW**: Added comprehensive QA review results and rework requirements | Quinn |

---

**Story 13.1 Status: üîÑ REVIEW - REQUIRES REWORK**

This story establishes the foundational infrastructure for AI-powered ESG extraction in GoCarbonTracker, providing a comprehensive, secure, and scalable solution for processing sustainability reports. The implementation follows established architectural patterns while introducing cutting-edge AI capabilities that position the platform as a market leader in ESG data processing.

**Current Implementation Status**: 25% Complete - Requires Significant Rework

**QA Review Summary**:
- **Security**: Basic proxy configuration complete, but missing environment validation and input sanitization
- **Type Safety**: Extensive use of `any` types requires complete type system overhaul
- **Functionality**: Core features (file upload, progress tracking, results display) not implemented
- **Testing**: Only 2 basic test cases, well below 90% coverage requirement
- **Performance**: No optimization features implemented

**Next Steps**: 
1. **Immediate Rework**: Address all critical security and functionality gaps identified in QA review
2. **Type System Overhaul**: Eliminate all `any` types and implement comprehensive interfaces
3. **Core Functionality**: Implement file upload, progress tracking, and results display
4. **Testing**: Achieve 90%+ test coverage before proceeding
5. **Security Review**: Complete security improvements and validation